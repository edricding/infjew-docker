<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Login | INFJEW - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- App favicon -->
  <link rel="shortcut icon" href="https://storage.googleapis.com/bucket-infjew/INFJEW/backend/images/favicon.jpg" />

  <!-- Theme Config Js -->
  <script src="/js/config.js"></script>

  <!-- Vendor css -->
  <link href="/css/vendor.min.css" rel="stylesheet" type="text/css" />

  <!-- App css -->
  <link href="/css/app.css" rel="stylesheet" type="text/css" id="app-style" />

  <!-- Icons css -->
  <link href="/css/icons.min.css" rel="stylesheet" type="text/css" />
</head>

<body>
  <div class="auth-bg d-flex min-vh-100 justify-content-center align-items-center">
    <div class="row g-0 justify-content-center w-100 m-xxl-5 px-xxl-4 m-3">
      <div class="col-xl-4 col-lg-5 col-md-6">
        <div class="card overflow-hidden text-center h-100 p-xxl-4 p-3 mb-0">
          <a href="#" class="auth-brand mb-3">
            <img src="https://storage.googleapis.com/bucket-infjew/INFJEW/backend/images/logo-website.png"
              alt="dark logo" class="logo-dark col-lg-6 col-md-6 col-sm-12 col-xs-12 my-3" />
          </a>

          <h4 class="fw-semibold mb-2">Login your account</h4>

          <p class="text-muted mb-4">
            Enter your username and password to access admin dashboard.
          </p>

          <form class="text-start mb-3 needs-validation" novalidate>
            <div class="mb-3">
              <label class="form-label" for="login-username">Username</label>
              <input type="text" id="login-username" name="login-username" class="form-control"
                placeholder="Enter your username" required />
              <div id="login-username-msg" class="mt-1" style="color: #f36b21; font-size: 12px; display: none"></div>
            </div>

            <div class="mb-3">
              <label class="form-label" for="login-password">Password</label>
              <input type="password" id="login-password" class="form-control" placeholder="Enter your password"
                required />
              <div id="login-password-msg" class="mt-1" style="color: #f36b21; font-size: 12px; display: none"></div>
            </div>

            <div class="d-grid">
              <button class="btn btn-primary" id="login-submit-btn" type="button">
                Login
              </button>
            </div>
          </form>

          <div id="login-general-msg" class="mb-2" style="color: #f36b21; font-size: 12px; display: none"></div>

          <p class="mt-auto mb-0">
            2025 -
            <script>
              document.write(new Date().getFullYear());
            </script>
            @ INFJEW
          </p>
        </div>
      </div>
    </div>
  </div>

    <!-- Vendor js -->
    <script src="/js/vendor.min.js"></script>

    <!-- App js -->
    <script src="/js/app.js"></script>

    <script>
      window.__RECAPTCHA_ENABLED__ = true;
    </script>
    <script src="https://www.google.com/recaptcha/api.js?render=6LeLHmAsAAAAAIMDu4IcbDpVMrSn0QU4u0EyKHVr"></script>
    <script src="/js/BackendHttpRequest.js"></script>

  <script>
    (function () {
      var btn = document.getElementById("login-submit-btn");
      var usernameEl = document.getElementById("login-username");
      var passwordEl = document.getElementById("login-password");
      var userMsgEl = document.getElementById("login-username-msg");
      var passMsgEl = document.getElementById("login-password-msg");
      var generalMsgEl = document.getElementById("login-general-msg");
      var loginForm = document.querySelector("form.needs-validation");

      function showMsg(el, msg) {
        if (!el) {
          return;
        }
        if (!msg) {
          el.style.display = "none";
          el.textContent = "";
          return;
        }
        el.textContent = msg;
        el.style.display = "block";
      }

      function clearMsgs() {
        showMsg(userMsgEl, "");
        showMsg(passMsgEl, "");
        showMsg(generalMsgEl, "");
      }

      function delay(ms) {
        return new Promise(function (resolve) {
          setTimeout(resolve, ms);
        });
      }

      function redirectToDashboardWhenReady(maxAttempts, delayMs) {
        var attemptsLeft = typeof maxAttempts === "number" ? maxAttempts : 30;
        var waitMs = typeof delayMs === "number" ? delayMs : 120;

        function check() {
          return fetch("/api/session/require", {
            method: "GET",
            credentials: "include",
            cache: "no-store",
          })
            .then(function (res) {
              if (res.status === 204) {
                window.location.replace("/");
                return true;
              }
              if (attemptsLeft <= 1) {
                return false;
              }
              attemptsLeft -= 1;
              return delay(waitMs).then(check);
            })
            .catch(function () {
              if (attemptsLeft <= 1) {
                return false;
              }
              attemptsLeft -= 1;
              return delay(waitMs).then(check);
            });
        }

        return check();
      }

      function submitLogin() {
        if (btn.disabled) {
          return;
        }

        clearMsgs();

        var username = (usernameEl.value || "").trim();
        var password = passwordEl.value || "";

        var hasError = false;
        if (!username) {
          showMsg(userMsgEl, "Please enter your username.");
          hasError = true;
        }
        if (!password) {
          showMsg(passMsgEl, "Please enter your password.");
          hasError = true;
        }
        if (hasError) {
          return;
        }

        btn.disabled = true;

        if (!window.grecaptcha) {
          showMsg(generalMsgEl, "reCAPTCHA not ready.");
          btn.disabled = false;
          return;
        }

        grecaptcha.ready(function () {
          grecaptcha
            .execute("6LeLHmAsAAAAAIMDu4IcbDpVMrSn0QU4u0EyKHVr", { action: "login" })
            .then(function (token) {
              return fetch("/api/AuthLogin", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify({
                  username: username,
                  password: password,
                  recaptchaToken: token,
                }),
              });
            })
            .then(function (res) {
              return res.json();
            })
            .then(function (data) {
              if (data && data.success) {
                return redirectToDashboardWhenReady(50, 120).then(function (redirected) {
                  if (!redirected) {
                    showMsg(generalMsgEl, "Login succeeded, but session is not ready. Please retry.");
                  }
                });
              }
              showMsg(generalMsgEl, (data && data.message) || "Login failed");
            })
            .catch(function (err) {
              console.error("Login failed", err);
              showMsg(generalMsgEl, "Login failed");
            })
            .then(function () {
              btn.disabled = false;
            });
        });
      }

      window.addEventListener("DOMContentLoaded", function () {
        fetch("/api/session/status", {
          method: "GET",
          credentials: "include",
          cache: "no-store",
        })
          .then(function (res) {
            return res.json();
          })
          .then(function (data) {
            if (data && data.loggedIn) {
              return redirectToDashboardWhenReady(10, 120);
            }
          })
          .catch(function () {});
      });

      btn.addEventListener("click", submitLogin);

      if (loginForm) {
        loginForm.addEventListener("submit", function (e) {
          e.preventDefault();
          submitLogin();
        });
      }

      passwordEl.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          submitLogin();
        }
      });
    })();
  </script>
</body>

</html>
